name: Deploy Quiz to GitHub Pages

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Job de valida√ß√£o
  validate:
    name: Validar arquivos
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Validar HTML
        run: |
          echo "üîç Validando arquivos HTML..."
          if [ -f "index.html" ]; then
            echo "‚úÖ index.html encontrado"
            # Verificar se o HTML tem estrutura b√°sica
            if grep -q "<!DOCTYPE html>" index.html; then
              echo "‚úÖ DOCTYPE encontrado"
            else
              echo "‚ùå DOCTYPE n√£o encontrado"
              exit 1
            fi
          else
            echo "‚ùå index.html n√£o encontrado"
            exit 1
          fi

      - name: Validar CSS
        run: |
          echo "üé® Validando arquivos CSS..."
          if [ -f "styles.css" ]; then
            echo "‚úÖ styles.css encontrado"
            # Verificar se tem estilos b√°sicos
            if grep -q "body" styles.css; then
              echo "‚úÖ Estilos b√°sicos encontrados"
            else
              echo "‚ùå Estilos b√°sicos n√£o encontrados"
              exit 1
            fi
          else
            echo "‚ùå styles.css n√£o encontrado"
            exit 1
          fi

      - name: Validar JavaScript
        run: |
          echo "‚ö° Validando arquivos JavaScript..."
          if [ -f "script.js" ]; then
            echo "‚úÖ script.js encontrado"
            # Verificar se tem estrutura b√°sica do quiz
            if grep -q "quizData" script.js; then
              echo "‚úÖ Dados do quiz encontrados"
            else
              echo "‚ùå Dados do quiz n√£o encontrados"
              exit 1
            fi
          else
            echo "‚ùå script.js n√£o encontrado"
            exit 1
          fi

      - name: Verificar links
        run: |
          echo "üîó Verificando links entre arquivos..."
          # Verificar se HTML referencia CSS e JS
          if grep -q "styles.css" index.html && grep -q "script.js" index.html; then
            echo "‚úÖ Links para CSS e JS encontrados"
          else
            echo "‚ùå Links para CSS ou JS n√£o encontrados"
            exit 1
          fi

  # Job de build e valida√ß√£o
  build-and-validate:
    name: Build e Valida√ß√£o
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Instalar depend√™ncias de desenvolvimento
        run: |
          echo "üì¶ Instalando ferramentas de valida√ß√£o..."
          npm install -g html-validate
          npm install -g stylelint
          npm install -g eslint

      - name: Validar HTML com html-validate
        run: |
          echo "üîç Validando HTML com html-validate..."
          html-validate index.html || echo "‚ö†Ô∏è Avisos de valida√ß√£o HTML (n√£o cr√≠ticos)"

      - name: Validar CSS com stylelint
        run: |
          echo "üé® Validando CSS com stylelint..."
          stylelint styles.css || echo "‚ö†Ô∏è Avisos de valida√ß√£o CSS (n√£o cr√≠ticos)"

      - name: Validar JavaScript com eslint
        run: |
          echo "‚ö° Validando JavaScript com eslint..."
          eslint script.js || echo "‚ö†Ô∏è Avisos de valida√ß√£o JavaScript (n√£o cr√≠ticos)"

      - name: Otimizar arquivos
        run: |
          echo "‚ö° Otimizando arquivos..."
          # Minificar CSS (remover espa√ßos desnecess√°rios)
          if command -v sed >/dev/null 2>&1; then
            sed 's/  */ /g' styles.css | sed 's/; /;/g' | sed 's/ {/{/g' > styles.min.css
            echo "‚úÖ CSS otimizado"
          fi
          
          # Criar arquivo de vers√£o
          echo "v$(date +%Y%m%d-%H%M%S)" > version.txt
          echo "‚úÖ Arquivo de vers√£o criado"

      - name: Preparar arquivos para deploy
        run: |
          echo "üìÅ Preparando arquivos para deploy..."
          mkdir -p dist
          cp index.html dist/
          cp styles.css dist/
          cp script.js dist/
          cp README.md dist/
          
          # Criar arquivo de informa√ß√µes do deploy
          cat > dist/deploy-info.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "workflow": "${{ github.workflow }}",
            "runner": "${{ runner.os }}"
          }
          EOF
          
          echo "‚úÖ Arquivos preparados para deploy"

      - name: Upload artifact para download
        uses: actions/upload-artifact@v4
        with:
          name: quiz-files
          path: dist/
          retention-days: 30

      - name: Criar release com arquivos
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Quiz Release v${{ github.run_number }}
          body: |
            ## üéØ Quiz de Ci√™ncias da Computa√ß√£o
            
            ### üìÅ Arquivos Inclu√≠dos
            - `index.html` - P√°gina principal do quiz
            - `styles.css` - Estilos CSS responsivos
            - `script.js` - L√≥gica JavaScript
            - `README.md` - Documenta√ß√£o
            - `deploy-info.json` - Informa√ß√µes do deploy
            
            ### üöÄ Como Usar
            1. Baixe os arquivos do release
            2. Abra `index.html` em qualquer navegador
            3. Divirta-se com o quiz!
            
            ### üìä Valida√ß√µes Realizadas
            - ‚úÖ HTML validado com html-validate
            - ‚úÖ CSS validado com stylelint
            - ‚úÖ JavaScript validado com eslint
            - ‚úÖ Arquivos otimizados
            
            **Commit:** ${{ github.sha }}
            **Branch:** ${{ github.ref_name }}
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job de notifica√ß√£o (opcional)
  notify:
    name: Notificar Build
    runs-on: ubuntu-latest
    needs: build-and-validate
    if: always()
    steps:
      - name: Status do Build
        run: |
          if [ "${{ needs.build-and-validate.result }}" == "success" ]; then
            echo "üéâ Build realizado com sucesso!"
            echo "üìÅ Arquivos dispon√≠veis como artifact"
            echo "üì¶ Release criado automaticamente"
            echo "üîó Acesse a aba Releases para baixar os arquivos"
          else
            echo "‚ùå Build falhou"
            exit 1
          fi
