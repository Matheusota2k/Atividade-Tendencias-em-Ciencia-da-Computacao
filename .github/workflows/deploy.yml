name: Quiz Build and Validation

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # Job de valida√ß√£o b√°sica
  validate:
    name: Validar Arquivos
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Verificar arquivos essenciais
        run: |
          echo "üîç Verificando arquivos essenciais..."
          
          # Verificar se os arquivos existem
          if [ ! -f "index.html" ]; then
            echo "‚ùå index.html n√£o encontrado"
            exit 1
          fi
          
          if [ ! -f "styles.css" ]; then
            echo "‚ùå styles.css n√£o encontrado"
            exit 1
          fi
          
          if [ ! -f "script.js" ]; then
            echo "‚ùå script.js n√£o encontrado"
            exit 1
          fi
          
          echo "‚úÖ Todos os arquivos essenciais encontrados"

      - name: Verificar estrutura HTML
        run: |
          echo "üîç Verificando estrutura HTML..."
          
          # Verificar DOCTYPE
          if ! grep -q "<!DOCTYPE html>" index.html; then
            echo "‚ùå DOCTYPE n√£o encontrado"
            exit 1
          fi
          
          # Verificar links para CSS e JS
          if ! grep -q "styles.css" index.html; then
            echo "‚ùå Link para styles.css n√£o encontrado"
            exit 1
          fi
          
          if ! grep -q "script.js" index.html; then
            echo "‚ùå Link para script.js n√£o encontrado"
            exit 1
          fi
          
          echo "‚úÖ Estrutura HTML v√°lida"

      - name: Verificar estrutura JavaScript
        run: |
          echo "‚ö° Verificando estrutura JavaScript..."
          
          # Verificar se tem dados do quiz
          if ! grep -q "quizData" script.js; then
            echo "‚ùå Dados do quiz n√£o encontrados"
            exit 1
          fi
          
          # Verificar se tem fun√ß√µes principais
          if ! grep -q "loadQuestion" script.js; then
            echo "‚ùå Fun√ß√£o loadQuestion n√£o encontrada"
            exit 1
          fi
          
          echo "‚úÖ Estrutura JavaScript v√°lida"

  # Job de an√°lise est√°tica de seguran√ßa (SAST)
  sast:
    name: An√°lise Est√°tica de Seguran√ßa (SAST)
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Inicializar CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Autobuild CodeQL
        uses: github/codeql-action/autobuild@v3

      - name: Executar an√°lise CodeQL
        uses: github/codeql-action/analyze@v3

      - name: Verificar vulnerabilidades em JavaScript
        run: |
          echo "üîí Verificando vulnerabilidades de seguran√ßa no c√≥digo JavaScript..."
          
          # Verificar uso de eval() ou fun√ß√µes perigosas
          if grep -r "eval(" script.js 2>/dev/null; then
            echo "‚ö†Ô∏è  ATEN√á√ÉO: Uso de eval() detectado - pode ser um risco de seguran√ßa"
          fi
          
          # Verificar innerHTML sem sanitiza√ß√£o
          if grep -r "innerHTML" script.js 2>/dev/null; then
            echo "‚ö†Ô∏è  ATEN√á√ÉO: Uso de innerHTML detectado - verifique se h√° sanitiza√ß√£o"
          fi
          
          # Verificar console.log que podem expor informa√ß√µes sens√≠veis
          if grep -r "console.log" script.js 2>/dev/null; then
            echo "‚ÑπÔ∏è  Console.log detectado - remova em produ√ß√£o se necess√°rio"
          fi
          
          echo "‚úÖ An√°lise SAST conclu√≠da"

      - name: Verificar seguran√ßa de headers HTML
        run: |
          echo "üîí Verificando headers de seguran√ßa no HTML..."
          
          # Verificar se h√° meta tags de seguran√ßa
          if ! grep -q "Content-Security-Policy" index.html 2>/dev/null; then
            echo "‚ÑπÔ∏è  Considere adicionar Content-Security-Policy meta tag"
          fi
          
          # Verificar se h√° XSS protection
          if ! grep -q "X-XSS-Protection" index.html 2>/dev/null; then
            echo "‚ÑπÔ∏è  Considere adicionar X-XSS-Protection meta tag"
          fi
          
          echo "‚úÖ Verifica√ß√£o de headers conclu√≠da"

  # Job de an√°lise din√¢mica de seguran√ßa (DAST)
  dast:
    name: An√°lise Din√¢mica de Seguran√ßa (DAST)
    runs-on: ubuntu-latest
    needs: [validate, build]
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Download artifact do build
        uses: actions/download-artifact@v4
        with:
          pattern: quiz-ciencias-computacao-v*
          merge-multiple: true

      - name: Iniciar servidor web local
        run: |
          echo "üåê Iniciando servidor web local para testes..."
          
          # Verificar estrutura do artifact baixado
          ls -la
          
          # Instalar Python para servidor HTTP simples
          sudo apt-get update
          sudo apt-get install -y python3
          
          # Determinar diret√≥rio de trabalho (pode ser dist/ ou raiz dependendo do artifact)
          if [ -d "dist" ]; then
            WORK_DIR="dist"
          else
            WORK_DIR="."
          fi
          
          echo "üìÅ Diret√≥rio de trabalho: $WORK_DIR"
          
          # Iniciar servidor em background na porta 8000
          cd $WORK_DIR
          python3 -m http.server 8000 > /tmp/server.log 2>&1 &
          echo $! > /tmp/server.pid
          
          # Aguardar servidor iniciar
          sleep 5
          
          # Verificar se servidor est√° rodando
          if curl -f http://localhost:8000 > /dev/null 2>&1; then
            echo "‚úÖ Servidor web iniciado com sucesso na porta 8000"
          else
            echo "‚ùå Falha ao iniciar servidor web"
            cat /tmp/server.log || true
            exit 1
          fi

      - name: Executar OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.11.0
        with:
          target: 'http://localhost:8000'
          fail_action: false
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'

      - name: Verificar headers HTTP de seguran√ßa
        run: |
          echo "üîí Verificando headers HTTP de seguran√ßa..."
          
          # Verificar headers importantes
          HEADERS=$(curl -I http://localhost:8000 2>/dev/null)
          
          if echo "$HEADERS" | grep -q "X-Content-Type-Options"; then
            echo "‚úÖ X-Content-Type-Options configurado"
          else
            echo "‚ö†Ô∏è  X-Content-Type-Options n√£o encontrado"
          fi
          
          if echo "$HEADERS" | grep -q "X-Frame-Options"; then
            echo "‚úÖ X-Frame-Options configurado"
          else
            echo "‚ö†Ô∏è  X-Frame-Options n√£o encontrado"
          fi
          
          if echo "$HEADERS" | grep -q "Content-Security-Policy"; then
            echo "‚úÖ Content-Security-Policy configurado"
          else
            echo "‚ö†Ô∏è  Content-Security-Policy n√£o encontrado"
          fi
          
          echo "‚úÖ Verifica√ß√£o de headers HTTP conclu√≠da"

      - name: Testar vulnerabilidades comuns
        run: |
          echo "üîí Testando vulnerabilidades comuns..."
          
          # Testar se aplica√ß√£o responde a m√©todos HTTP perigosos
          echo "Testando m√©todos HTTP..."
          if curl -X TRACE http://localhost:8000 -I 2>/dev/null | grep -q "200"; then
            echo "‚ö†Ô∏è  M√©todo TRACE habilitado - considere desabilitar"
          fi
          
          # Testar acesso a arquivos sens√≠veis
          echo "Testando acesso a arquivos sens√≠veis..."
          if curl -f http://localhost:8000/.git/config 2>/dev/null; then
            echo "‚ùå CR√çTICO: Diret√≥rio .git acess√≠vel publicamente!"
            exit 1
          fi
          
          if curl -f http://localhost:8000/.env 2>/dev/null; then
            echo "‚ùå CR√çTICO: Arquivo .env acess√≠vel publicamente!"
            exit 1
          fi
          
          echo "‚úÖ Testes de vulnerabilidades conclu√≠dos"

      - name: Parar servidor web
        if: always()
        run: |
          echo "üõë Parando servidor web..."
          if [ -f /tmp/server.pid ]; then
            SERVER_PID=$(cat /tmp/server.pid)
            kill $SERVER_PID 2>/dev/null || true
            rm /tmp/server.pid || true
          fi
          pkill -f "python3 -m http.server" || true
          echo "‚úÖ Servidor web parado"

      - name: Upload relat√≥rio ZAP
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: |
            zap_report.json
            zap_report.html
          retention-days: 30

  # Job de build e prepara√ß√£o
  build:
    name: Build e Prepara√ß√£o
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Preparar arquivos
        run: |
          echo "üìÅ Preparando arquivos para distribui√ß√£o..."
          
          # Criar diret√≥rio de distribui√ß√£o
          mkdir -p dist
          
          # Copiar arquivos principais
          cp index.html dist/
          cp styles.css dist/
          cp script.js dist/
          cp README.md dist/
          
          echo "‚úÖ Arquivos copiados para dist/"

      - name: Criar arquivo de informa√ß√µes
        run: |
          echo "üìä Criando arquivo de informa√ß√µes..."
          
          cat > dist/build-info.json << EOF
          {
            "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "workflow": "${{ github.workflow }}",
            "build_number": "${{ github.run_number }}"
          }
          EOF
          
          echo "‚úÖ Arquivo de informa√ß√µes criado"

      - name: Criar arquivo de instru√ß√µes
        run: |
          echo "üìã Criando arquivo de instru√ß√µes..."
          
          cat > dist/COMO-USAR.md << EOF
          # üéØ Quiz de Ci√™ncias da Computa√ß√£o
          
          ## üìÅ Arquivos Inclu√≠dos
          - \`index.html\` - P√°gina principal do quiz
          - \`styles.css\` - Estilos CSS responsivos
          - \`script.js\` - L√≥gica JavaScript
          - \`README.md\` - Documenta√ß√£o completa
          - \`build-info.json\` - Informa√ß√µes do build
          
          ## üöÄ Como Usar
          1. Baixe todos os arquivos desta pasta
          2. Abra \`index.html\` em qualquer navegador
          3. Responda √†s perguntas do quiz
          4. Veja sua pontua√ß√£o final!
          
          ## üéÆ Controles
          - Clique nas op√ß√µes para responder
          - Use as teclas 1-4 para navegar pelas op√ß√µes
          - Pressione Enter para avan√ßar
          - Use "Jogar Novamente" para reiniciar
          
          ## üìä Sobre o Quiz
          - 8 perguntas sobre Ci√™ncias da Computa√ß√£o
          - Interface responsiva para desktop e mobile
          - Sistema de pontua√ß√£o com feedback visual
          - Temas: Programa√ß√£o, Algoritmos, Redes, Estruturas de Dados
          
          **Build:** v${{ github.run_number }}
          **Commit:** ${{ github.sha }}
          **Data:** $(date '+%d/%m/%Y %H:%M')
          EOF
          
          echo "‚úÖ Arquivo de instru√ß√µes criado"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: quiz-ciencias-computacao-v${{ github.run_number }}
          path: dist/
          retention-days: 30

  # Job de notifica√ß√£o
  notify:
    name: Notificar Sucesso
    runs-on: ubuntu-latest
    needs: [validate, build, sast, dast]
    if: always()
    steps:
      - name: Status Final
        run: |
          VALIDATE_STATUS="${{ needs.validate.result }}"
          BUILD_STATUS="${{ needs.build.result }}"
          SAST_STATUS="${{ needs.sast.result }}"
          DAST_STATUS="${{ needs.dast.result }}"
          
          echo "üìä Status dos Jobs:"
          echo "  ‚úÖ Valida√ß√£o: $VALIDATE_STATUS"
          echo "  ‚úÖ Build: $BUILD_STATUS"
          echo "  üîí SAST: $SAST_STATUS"
          echo "  üîí DAST: $DAST_STATUS"
          
          if [ "$VALIDATE_STATUS" == "success" ] && [ "$BUILD_STATUS" == "success" ] && [ "$SAST_STATUS" == "success" ] && [ "$DAST_STATUS" == "success" ]; then
            echo ""
            echo "üéâ Pipeline conclu√≠do com sucesso!"
            echo "üìÅ Arquivos dispon√≠veis como artifact"
            echo "üì¶ Nome do artifact: quiz-ciencias-computacao-v${{ github.run_number }}"
            echo "üîí An√°lises de seguran√ßa (SAST e DAST) conclu√≠das"
            echo "üîó Acesse a aba Actions para baixar"
            echo "üìã Instru√ß√µes inclu√≠das no arquivo COMO-USAR.md"
          else
            echo ""
            echo "‚ùå Pipeline falhou ou teve avisos"
            echo "üîç Verifique os logs para mais detalhes"
            if [ "$SAST_STATUS" != "success" ]; then
              echo "‚ö†Ô∏è  SAST: Verifique os relat√≥rios de seguran√ßa est√°tica"
            fi
            if [ "$DAST_STATUS" != "success" ]; then
              echo "‚ö†Ô∏è  DAST: Verifique os relat√≥rios de seguran√ßa din√¢mica"
            fi
            exit 1
          fi